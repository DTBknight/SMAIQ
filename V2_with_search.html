<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>汽车报价计算器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            accent: '#FF7D00',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 10px 30px -5px rgba(22, 93, 255, 0.1);
      }
      .input-focus {
        @apply focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none;
      }
      .transition-custom {
        @apply transition-all duration-300 ease-in-out;
      }
      .animate-fadeIn {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* 去掉所有数值输入框的上下调节按钮 */
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-dark min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-50 transition-custom">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-car text-primary text-2xl"></i>
        <h1 class="text-[clamp(1.25rem,3vw,1.75rem)] font-bold text-dark">汽车报价计算器</h1>
      </div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="container mx-auto px-4 py-8">
    <!-- 表单卡片 -->
    <div class="bg-white rounded-xl shadow-md p-6 md:p-8 mb-8">
      <form id="carQuoteForm" class="space-y-8">
        <!-- 基础信息部分 -->
        <section class="border-b border-gray-100 pb-6">
          <h3 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-info-circle text-primary mr-2"></i>基础信息
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 车型名称 -->
            <div class="space-y-2">
              <label for="carModel" class="block text-sm font-medium text-gray-700">车型名称</label>
              <input 
                type="text" 
                id="carModel" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="例如：特斯拉 Model 3"
                required
              >
              <!-- 车型搜索结果显示 -->
              <div id="carSearchResults" class="hidden mt-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-lg">
                <!-- 动态填充搜索结果 -->
              </div>
            </div>
            
            <!-- 出口类型 -->
            <div class="space-y-2">
              <label for="carType" class="block text-sm font-medium text-gray-700">出口类型</label>
              <select 
                id="carType" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                required
              >
                <option value="">请选择出口类型</option>
                <option value="new" selected>新车</option>
                <option value="used">二手车</option>
                <option value="newEnergyTax">新能源（购置税）</option>
                <option value="newEnergyNoTax">新能源（无购置税）</option>
              </select>
            </div>
          </div>
        </section>
        
        <!-- 新车表单 (默认隐藏，选择新车时显示) -->
        <section id="newCarForm" class="hidden space-y-6">
          <h3 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-car text-primary mr-2"></i>新车报价信息
          </h3>
          
          <!-- 报价类型 -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">报价类型</label>
            <div class="flex flex-wrap gap-3">
              <label class="inline-flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-custom">
                <input type="radio" name="quoteType" value="EXW" class="text-primary focus:ring-primary" checked>
                <span class="ml-2">EXW</span>
              </label>
              <label class="inline-flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-custom">
                <input type="radio" name="quoteType" value="FOB" class="text-primary focus:ring-primary">
                <span class="ml-2">FOB</span>
              </label>
              <label class="inline-flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-custom">
                <input type="radio" name="quoteType" value="CIF" class="text-primary focus:ring-primary">
                <span class="ml-2">CIF</span>
              </label>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 指导价 -->
            <div class="space-y-2">
              <label for="guidePrice" class="block text-sm font-medium text-gray-700">指导价 (元)</label>
              <input 
                type="number" 
                id="guidePrice" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入指导价"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 优惠 -->
            <div class="space-y-2">
              <label for="discount" class="block text-sm font-medium text-gray-700">优惠 (元)</label>
              <input 
                type="number" 
                id="discount" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入优惠金额"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 开票价 (自动计算) -->
            <div class="space-y-2">
              <label for="invoicePrice" class="block text-sm font-medium text-gray-700">开票价 (元)</label>
              <input 
                type="number" 
                id="invoicePrice" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
            
            <!-- 手续费 -->
            <div class="space-y-2">
              <label for="serviceFeeRate" class="block text-sm font-medium text-gray-700">手续费</label>
              <div class="flex flex-col">
                <input 
                  type="range" 
                  id="serviceFeeRate" 
                  min="0.04" 
                  max="0.1" 
                  step="0.01" 
                  value="0.04"
                  class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"
                >
                <div class="flex justify-between mt-1">
                  <span id="serviceFeeRateValue" class="text-sm text-gray-600">0.04</span>
                  <span id="serviceFee" class="text-sm font-medium text-primary">0.00 元</span>
                </div>
              </div>
            </div>
            
            <!-- 退税 -->
            <div class="space-y-2">
              <label for="taxRefund" class="block text-sm font-medium text-gray-700">退税 (元)</label>
              <input 
                type="number" 
                id="taxRefund" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
            
            <!-- 国内运输 -->
            <div class="space-y-2">
              <label for="domesticShipping" class="block text-sm font-medium text-gray-700">国内运输 (元)</label>
              <input 
                type="number" 
                id="domesticShipping" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入国内运输费用"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 国际运输 (条件显示) -->
            <div id="internationalShippingContainer" class="space-y-2 hidden">
              <label for="internationalShipping" class="block text-sm font-medium text-gray-700">国际运输 (元)</label>
              <input 
                type="number" 
                id="internationalShipping" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入国际运输费用"
                step="0.01"
                min="0"
              >
            </div>
          </div>
          
          <!-- 购车成本 (自动计算) -->
          <div class="space-y-2">
            <label for="purchaseCost" class="block text-sm font-medium text-gray-700">购车成本 (元)</label>
            <input 
              type="number" 
              id="purchaseCost" 
              class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
              placeholder="自动计算"
              step="0.01"
              readonly
            >
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 利润 -->
            <div class="space-y-2">
              <label for="profit" class="block text-sm font-medium text-gray-700">利润 (元)</label>
              <input 
                type="number" 
                id="profit" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入期望利润"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 报价（人民币） -->
            <div class="space-y-2">
              <label for="rmbQuote" class="block text-sm font-medium text-gray-700">报价（人民币） (元)</label>
              <input 
                type="number" 
                id="rmbQuote" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
          </div>
        </section>
        
        <!-- 二手车表单 (默认隐藏) -->
        <section id="usedCarForm" class="hidden space-y-6">
          <h3 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-car text-primary mr-2"></i>二手车报价信息
          </h3>
          
          <!-- 报价类型 -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">报价类型</label>
            <div class="flex flex-wrap gap-3">
              <label class="inline-flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-custom">
                <input type="radio" name="usedQuoteType" value="EXW" class="text-primary focus:ring-primary" checked>
                <span class="ml-2">EXW</span>
              </label>
              <label class="inline-flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-custom">
                <input type="radio" name="usedQuoteType" value="FOB" class="text-primary focus:ring-primary">
                <span class="ml-2">FOB</span>
              </label>
              <label class="inline-flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-custom">
                <input type="radio" name="usedQuoteType" value="CIF" class="text-primary focus:ring-primary">
                <span class="ml-2">CIF</span>
              </label>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 指导价 -->
            <div class="space-y-2">
              <label for="usedGuidePrice" class="block text-sm font-medium text-gray-700">指导价 (元)</label>
              <input 
                type="number" 
                id="usedGuidePrice" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入指导价"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 优惠 -->
            <div class="space-y-2">
              <label for="usedDiscount" class="block text-sm font-medium text-gray-700">优惠 (元)</label>
              <input 
                type="number" 
                id="usedDiscount" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入优惠金额"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 开票价 (自动计算) -->
            <div class="space-y-2">
              <label for="usedInvoicePrice" class="block text-sm font-medium text-gray-700">开票价 (元)</label>
              <input 
                type="number" 
                id="usedInvoicePrice" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
            
            <!-- 购置税 (自动计算) -->
            <div class="space-y-2">
              <label for="usedPurchaseTax" class="block text-sm font-medium text-gray-700">购置税 (元)</label>
              <input 
                type="number" 
                id="usedPurchaseTax" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
            
            <!-- 资质费用 -->
            <div class="space-y-2">
              <label for="usedQualificationFee" class="block text-sm font-medium text-gray-700">资质费用 (元)</label>
              <input 
                type="number" 
                id="usedQualificationFee" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入资质费用"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 代办费 -->
            <div class="space-y-2">
              <label for="usedAgencyFee" class="block text-sm font-medium text-gray-700">代办费 (元)</label>
              <input 
                type="number" 
                id="usedAgencyFee" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入代办费用"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 退税 (自动计算) -->
            <div class="space-y-2">
              <label for="usedTaxRefund" class="block text-sm font-medium text-gray-700">退税 (元)</label>
              <input 
                type="number" 
                id="usedTaxRefund" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
            
            <!-- 退税手续费 (自动计算) -->
            <div class="space-y-2">
              <label for="usedTaxRefundFee" class="block text-sm font-medium text-gray-700">退税手续费 (元)</label>
              <input 
                type="number" 
                id="usedTaxRefundFee" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
            
            <!-- 国内运输 -->
            <div class="space-y-2">
              <label for="usedDomesticShipping" class="block text-sm font-medium text-gray-700">国内运输 (元)</label>
              <input 
                type="number" 
                id="usedDomesticShipping" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入国内运输费用"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 国际运输 (条件显示) -->
            <div id="usedInternationalShippingContainer" class="space-y-2 hidden">
              <label for="usedInternationalShipping" class="block text-sm font-medium text-gray-700">国际运输 (元)</label>
              <input 
                type="number" 
                id="usedInternationalShipping" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入国际运输费用"
                step="0.01"
                min="0"
              >
            </div>
          </div>
          
          <!-- 购车成本 (自动计算) -->
          <div class="space-y-2">
            <label for="usedPurchaseCost" class="block text-sm font-medium text-gray-700">购车成本 (元)</label>
            <input 
              type="number" 
              id="usedPurchaseCost" 
              class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
              placeholder="自动计算"
              step="0.01"
              readonly
            >
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 利润 -->
            <div class="space-y-2">
              <label for="usedProfit" class="block text-sm font-medium text-gray-700">利润 (元)</label>
              <input 
                type="number" 
                id="usedProfit" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="输入期望利润"
                step="0.01"
                min="0"
              >
            </div>
            
            <!-- 报价（人民币） -->
            <div class="space-y-2">
              <label for="usedRmbQuote" class="block text-sm font-medium text-gray-700">报价（人民币） (元)</label>
              <input 
                type="number" 
                id="usedRmbQuote" 
                class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
          </div>
        </section>
        
        <!-- 新能源（购置税）表单 (默认隐藏) -->
        <section id="newEnergyTaxForm" class="hidden">
          <h3 class="text-xl font-semibold mb-4">新能源（购置税）报价信息</h3>
          <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
            <p class="text-gray-500 text-center">新能源（购置税）表单功能正在开发中...</p>
          </div>
        </section>
        
        <!-- 新能源（无购置税）表单 (默认隐藏) -->
        <section id="newEnergyNoTaxForm" class="hidden">
          <h3 class="text-xl font-semibold mb-4">新能源（无购置税）报价信息</h3>
          <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
            <p class="text-gray-500 text-center">新能源（无购置税）表单功能正在开发中...</p>
          </div>
        </section>
        
        <!-- 汇率和最终报价统一显示在表单下方 -->
        <div id="currencySectionContainer" class="mt-4">
          <!-- 汇率和最终报价（移到新车/二手车表单下方，统一显示） -->
          <div id="currencySection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 hidden">
            <div class="space-y-2">
              <label for="currency" class="block text-sm font-medium text-gray-700">选择币种</label>
              <select 
                id="currency" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
              >
                <option value="">请选择币种</option>
                <option value="USD" selected>美元 (USD)</option>
                <option value="EUR">欧元 (EUR)</option>
                <option value="GBP">英镑 (GBP)</option>
              </select>
            </div>
            <div class="space-y-2">
              <label for="exchangeRate" class="block text-sm font-medium text-gray-700" id="exchangeRateLabel">汇率 实时基准：显示汇率数值</label>
              <input 
                type="number" 
                id="exchangeRate" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-custom"
                placeholder="加载中..."
                step="0.0001"
              >
            </div>
            <div class="space-y-2 md:col-span-2">
              <label for="finalQuote" class="block text-sm font-medium text-gray-700">最终报价</label>
              <input 
                type="number" 
                id="finalQuote" 
                class="w-full px-4 py-3 border-2 border-primary bg-primary/5 rounded-lg text-lg font-medium input-focus transition-custom"
                placeholder="自动计算"
                step="0.01"
                readonly
              >
            </div>
          </div>
        </div>
        
        <!-- 提交按钮 -->
        <div class="flex justify-center pt-4">
          <button 
            type="button" 
            id="calculateBtn"
            class="px-8 py-3 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-custom flex items-center"
          >
            <i class="fa fa-calculator mr-2"></i>计算报价
          </button>
        </div>
      </form>
    </div>
    
    <!-- 报价结果卡片 -->
    <div id="resultCard" class="hidden bg-white rounded-xl shadow-md p-6 md:p-8 mb-8 transform transition-custom hover:shadow-lg">
      <h3 class="text-xl font-semibold mb-6 flex items-center">
        <i class="fa fa-file-text-o text-primary mr-2"></i>报价结果
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="border-b border-gray-100 pb-4 md:border-b-0 md:border-r border-gray-100 md:pr-6">
          <h4 class="text-lg font-medium text-gray-700 mb-4">基础信息</h4>
          <ul class="space-y-3">
            <li class="flex justify-between">
              <span class="text-gray-600">车型名称:</span>
              <span id="resultCarModel" class="font-medium"></span>
            </li>
            <li class="flex justify-between">
              <span class="text-gray-600">车型类型:</span>
              <span id="resultCarType" class="font-medium"></span>
            </li>
            <li class="flex justify-between">
              <span class="text-gray-600">报价类型:</span>
              <span id="resultQuoteType" class="font-medium"></span>
            </li>
          </ul>
        </div>
        
        <div>
          <h4 class="text-lg font-medium text-gray-700 mb-4">成本明细</h4>
          <ul class="space-y-3" id="resultCostDetails">
            <!-- 动态填充 -->
          </ul>
        </div>
      </div>
      
      <div class="mt-6 pt-6 border-t border-gray-100">
        <h4 class="text-lg font-medium text-gray-700 mb-4">报价汇总</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <div class="text-sm text-gray-500 mb-1">人民币报价</div>
            <div id="resultRmbQuote" class="text-lg font-semibold"></div>
          </div>
          <div class="bg-primary/10 p-4 rounded-lg text-center border border-primary/20">
            <div class="text-sm text-gray-500 mb-1" id="resultCurrencyText">最终报价 (USD)</div>
            <div id="resultFinalQuote" class="text-lg font-semibold text-primary"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-dark text-white py-8">
    <div class="container mx-auto px-4">
      <div class="text-center text-gray-500 text-sm">
        Designed by DTBKnight
      </div>
    </div>
  </footer>

  <script>
    // 格式化数字为货币格式
    function formatCurrency(value, currency = 'CNY') {
      if (isNaN(value) || value === '' || value === null) return '0.00';
      
      const options = {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      };
      
      if (currency === 'CNY') {
        options.style = 'currency';
        options.currency = 'CNY';
      } else if (currency === 'USD') {
        options.style = 'currency';
        options.currency = 'USD';
      } else if (currency === 'EUR') {
        options.style = 'currency';
        options.currency = 'EUR';
      } else if (currency === 'GBP') {
        options.style = 'currency';
        options.currency = 'GBP';
      }
      
      return new Intl.NumberFormat('zh-CN', options).format(value);
    }
    
    // 格式化数字为整数货币格式（不显示小数点）
    function formatCurrencyInteger(value, currency = 'CNY') {
      if (isNaN(value) || value === '' || value === null) return '¥0';
      
      const options = {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      };
      
      if (currency === 'CNY') {
        options.style = 'currency';
        options.currency = 'CNY';
      } else if (currency === 'USD') {
        options.style = 'currency';
        options.currency = 'USD';
      } else if (currency === 'EUR') {
        options.style = 'currency';
        options.currency = 'EUR';
      } else if (currency === 'GBP') {
        options.style = 'currency';
        options.currency = 'GBP';
      }
      
      return new Intl.NumberFormat('zh-CN', options).format(value);
    }
    
    // 处理车型类型切换 - 核心修复部分
    document.getElementById('carType').addEventListener('change', function() {
      const carType = this.value;
      
      // 隐藏所有表单
      document.getElementById('newCarForm').classList.add('hidden');
      document.getElementById('usedCarForm').classList.add('hidden');
      document.getElementById('newEnergyTaxForm').classList.add('hidden');
      document.getElementById('newEnergyNoTaxForm').classList.add('hidden');
      
      // 显示选中的表单
      if (carType === 'new') {
        document.getElementById('newCarForm').classList.remove('hidden');
        document.getElementById('newCarForm').classList.add('animate-fadeIn');
      } else if (carType === 'used') {
        document.getElementById('usedCarForm').classList.remove('hidden');
        document.getElementById('usedCarForm').classList.add('animate-fadeIn');
      } else if (carType === 'newEnergyTax') {
        document.getElementById('newEnergyTaxForm').classList.remove('hidden');
      } else if (carType === 'newEnergyNoTax') {
        document.getElementById('newEnergyNoTaxForm').classList.remove('hidden');
      }
    });
    
    // 处理新车报价类型切换（显示/隐藏国际运输）
    document.querySelectorAll('input[name="quoteType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const container = document.getElementById('internationalShippingContainer');
        if (this.value === 'EXW') {
          container.classList.add('hidden');
          document.getElementById('internationalShipping').value = '';
        } else {
          container.classList.remove('hidden');
          container.classList.add('animate-fadeIn');
        }
        calculateNewCarAll();
      });
    });
    
    // 处理二手车报价类型切换（显示/隐藏国际运输）
    document.querySelectorAll('input[name="usedQuoteType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const container = document.getElementById('usedInternationalShippingContainer');
        if (this.value === 'EXW') {
          container.classList.add('hidden');
          document.getElementById('usedInternationalShipping').value = '';
        } else {
          container.classList.remove('hidden');
          container.classList.add('animate-fadeIn');
        }
        calculateUsedCarAll();
      });
    });
    
    // 新车表单 - 手续费系数滑块
    const serviceFeeRate = document.getElementById('serviceFeeRate');
    const serviceFeeRateValue = document.getElementById('serviceFeeRateValue');
    const serviceFee = document.getElementById('serviceFee');
    
    serviceFeeRate.addEventListener('input', function() {
      const value = parseFloat(this.value).toFixed(2);
      serviceFeeRateValue.textContent = value;
      calculateNewCarServiceFee();
      calculateNewCarPurchaseCost();
      calculateNewCarRmbQuote();
      calculateFinalQuote();
    });
    
    // 新车计算 - 开票价
    function calculateNewCarInvoicePrice() {
      const guidePrice = parseFloat(document.getElementById('guidePrice').value) || 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const invoicePrice = Math.max(0, guidePrice - discount);
      document.getElementById('invoicePrice').value = Math.round(invoicePrice);
      return invoicePrice;
    }
    
    // 新车计算 - 退税
    function calculateNewCarTaxRefund() {
      const invoicePrice = parseFloat(document.getElementById('invoicePrice').value) || 0;
      const taxRefund = invoicePrice / 1.13 * 0.13;
      document.getElementById('taxRefund').value = taxRefund.toFixed(2);
      return taxRefund;
    }
    
    // 新车计算 - 手续费
    function calculateNewCarServiceFee() {
      const rate = parseFloat(document.getElementById('serviceFeeRate').value);
      const invoicePrice = parseFloat(document.getElementById('invoicePrice').value) || 0;
      const fee = rate * invoicePrice;
      serviceFee.textContent = formatCurrency(Math.round(fee));
      return fee;
    }
    
    // 新车计算 - 购车成本
    function calculateNewCarPurchaseCost() {
      const invoicePrice = parseFloat(document.getElementById('invoicePrice').value) || 0;
      const serviceFee = calculateNewCarServiceFee();
      const domesticShipping = parseFloat(document.getElementById('domesticShipping').value) || 0;
      const internationalShipping = parseFloat(document.getElementById('internationalShipping').value) || 0;
      const taxRefund = parseFloat(document.getElementById('taxRefund').value) || 0;
      
      const purchaseCost = invoicePrice + serviceFee + domesticShipping + internationalShipping - taxRefund;
      document.getElementById('purchaseCost').value = Math.round(purchaseCost);
      return purchaseCost;
    }
    
    // 新车计算 - 人民币报价
    function calculateNewCarRmbQuote() {
      const purchaseCost = parseFloat(document.getElementById('purchaseCost').value) || 0;
      const profit = parseFloat(document.getElementById('profit').value) || 0;
      const rmbQuote = purchaseCost + profit;
      document.getElementById('rmbQuote').value = Math.round(rmbQuote);
      return rmbQuote;
    }
    
    // 二手车计算 - 开票价
    function calculateUsedCarInvoicePrice() {
      const guidePrice = parseFloat(document.getElementById('usedGuidePrice').value) || 0;
      const discount = parseFloat(document.getElementById('usedDiscount').value) || 0;
      const invoicePrice = Math.max(0, guidePrice - discount);
      document.getElementById('usedInvoicePrice').value = Math.round(invoicePrice);
      return invoicePrice;
    }
    
    // 二手车计算 - 购置税
    function calculateUsedCarPurchaseTax() {
      const invoicePrice = parseFloat(document.getElementById('usedInvoicePrice').value) || 0;
      const purchaseTax = invoicePrice / 11.3;
      document.getElementById('usedPurchaseTax').value = purchaseTax.toFixed(2);
      return purchaseTax;
    }
    
    // 二手车计算 - 退税
    function calculateUsedCarTaxRefund() {
      const invoicePrice = parseFloat(document.getElementById('usedInvoicePrice').value) || 0;
      const taxRefund = invoicePrice / 1.13 * 0.13;
      document.getElementById('usedTaxRefund').value = taxRefund.toFixed(2);
      return taxRefund;
    }
    
    // 二手车计算 - 退税手续费
    function calculateUsedCarTaxRefundFee() {
      const taxRefund = parseFloat(document.getElementById('usedTaxRefund').value) || 0;
      const taxRefundFee = taxRefund * 0.025;
      document.getElementById('usedTaxRefundFee').value = Math.round(taxRefundFee);
      return taxRefundFee;
    }
    
    // 二手车计算 - 购车成本
    function calculateUsedCarPurchaseCost() {
      const invoicePrice = parseFloat(document.getElementById('usedInvoicePrice').value) || 0;
      const purchaseTax = calculateUsedCarPurchaseTax();
      const qualificationFee = parseFloat(document.getElementById('usedQualificationFee').value) || 0;
      const agencyFee = parseFloat(document.getElementById('usedAgencyFee').value) || 0;
      const taxRefund = parseFloat(document.getElementById('usedTaxRefund').value) || 0;
      const taxRefundFee = calculateUsedCarTaxRefundFee();
      const domesticShipping = parseFloat(document.getElementById('usedDomesticShipping').value) || 0;
      const internationalShipping = parseFloat(document.getElementById('usedInternationalShipping').value) || 0;
      
      const purchaseCost = invoicePrice + purchaseTax + qualificationFee + agencyFee + taxRefundFee + domesticShipping + internationalShipping - taxRefund;
      document.getElementById('usedPurchaseCost').value = Math.round(purchaseCost);
      return purchaseCost;
    }
    
    // 二手车计算 - 人民币报价
    function calculateUsedCarRmbQuote() {
      const purchaseCost = parseFloat(document.getElementById('usedPurchaseCost').value) || 0;
      const profit = parseFloat(document.getElementById('usedProfit').value) || 0;
      const rmbQuote = purchaseCost + profit;
      document.getElementById('usedRmbQuote').value = Math.round(rmbQuote);
      return rmbQuote;
    }
    
    // 计算最终报价（新车、二手车都适用）
    function calculateFinalQuote() {
      const carType = document.getElementById('carType').value;
      let rmbQuote = 0;
      if (carType === 'new') {
        rmbQuote = parseFloat(document.getElementById('rmbQuote').value) || 0;
      } else if (carType === 'used') {
        rmbQuote = parseFloat(document.getElementById('usedRmbQuote').value) || 0;
      }
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0;
      const currency = document.getElementById('currency').value;
      if (currency && exchangeRate > 0 && rmbQuote > 0) {
        const finalQuote = rmbQuote / exchangeRate; // 使用数值栏的汇率（已减去0.05）
        document.getElementById('finalQuote').value = Math.round(finalQuote);
        return finalQuote;
      }
      document.getElementById('finalQuote').value = '';
      return 0;
    }
    
    // 新车计算 - 所有计算
    function calculateNewCarAll() {
      calculateNewCarInvoicePrice();
      calculateNewCarTaxRefund();
      calculateNewCarServiceFee();
      calculateNewCarPurchaseCost();
      calculateNewCarRmbQuote();
      calculateFinalQuote();
    }
    
    // 二手车计算 - 所有计算
    function calculateUsedCarAll() {
      calculateUsedCarInvoicePrice();
      calculateUsedCarPurchaseTax();
      calculateUsedCarTaxRefund();
      calculateUsedCarTaxRefundFee();
      calculateUsedCarPurchaseCost();
      calculateUsedCarRmbQuote();
      calculateFinalQuote();
    }
    
    // 绑定新车表单输入事件
    document.getElementById('guidePrice').addEventListener('input', calculateNewCarAll);
    document.getElementById('discount').addEventListener('input', calculateNewCarAll);
    document.getElementById('domesticShipping').addEventListener('input', calculateNewCarAll);
    document.getElementById('internationalShipping').addEventListener('input', calculateNewCarAll);
    document.getElementById('profit').addEventListener('input', calculateNewCarAll);
    
    // 绑定二手车表单输入事件
    document.getElementById('usedGuidePrice').addEventListener('input', calculateUsedCarAll);
    document.getElementById('usedDiscount').addEventListener('input', calculateUsedCarAll);
    document.getElementById('usedQualificationFee').addEventListener('input', calculateUsedCarAll);
    document.getElementById('usedAgencyFee').addEventListener('input', calculateUsedCarAll);
    document.getElementById('usedDomesticShipping').addEventListener('input', calculateUsedCarAll);
    document.getElementById('usedInternationalShipping').addEventListener('input', calculateUsedCarAll);
    document.getElementById('usedProfit').addEventListener('input', calculateUsedCarAll);
    
    // 新车、二手车输入变动时都重新计算最终报价
    document.getElementById('rmbQuote').addEventListener('input', calculateFinalQuote);
    document.getElementById('usedRmbQuote').addEventListener('input', calculateFinalQuote);
    
    // 让汇率和最终报价在新车/二手车表单下方显示
    function moveCurrencySection() {
      const carType = document.getElementById('carType').value;
      const currencySection = document.getElementById('currencySection');
      if (carType === 'new' || carType === 'used') {
        currencySection.classList.remove('hidden');
      } else {
        currencySection.classList.add('hidden');
      }
    }
    document.getElementById('carType').addEventListener('change', moveCurrencySection);
    window.addEventListener('DOMContentLoaded', moveCurrencySection);

    // 绑定币种和汇率事件（新车、二手车都适用）
    document.getElementById('currency').addEventListener('change', function() {
      const currency = this.value;
      if (currency) {
        fetchExchangeRate(currency);
      } else {
        document.getElementById('exchangeRate').value = '';
        document.getElementById('finalQuote').value = '';
      }
    });
    
    // 汇率输入框手动输入事件
    document.getElementById('exchangeRate').addEventListener('input', function() {
      calculateFinalQuote();
    });
    
    // 计算按钮点击事件
    document.getElementById('calculateBtn').addEventListener('click', function() {
      const carType = document.getElementById('carType').value;
      
      // 根据车型类型计算
      if (carType === 'new') {
        calculateNewCarAll();
      } else if (carType === 'used') {
        calculateUsedCarAll();
      }
      
      // 显示结果卡片
      const resultCard = document.getElementById('resultCard');
      resultCard.classList.remove('hidden');
      resultCard.classList.add('animate-fadeIn');
      
      // 填充结果数据
      fillResultData();
      
      // 滚动到结果区域
      resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    
    // 填充结果数据
    function fillResultData() {
      const carType = document.getElementById('carType').value;
      const carTypeText = document.getElementById('carType').options[document.getElementById('carType').selectedIndex].text;
      
      // 基础信息
      document.getElementById('resultCarModel').textContent = document.getElementById('carModel').value || '未填写';
      document.getElementById('resultCarType').textContent = carTypeText || '未选择';
      
      // 报价类型
      let quoteTypeText = '未选择';
      if (carType === 'new') {
        document.querySelectorAll('input[name="quoteType"]').forEach(radio => {
          if (radio.checked) quoteTypeText = radio.value;
        });
      } else if (carType === 'used') {
        document.querySelectorAll('input[name="usedQuoteType"]').forEach(radio => {
          if (radio.checked) quoteTypeText = radio.value;
        });
      }
      document.getElementById('resultQuoteType').textContent = quoteTypeText;
      
      // 填充成本明细
      const costDetails = document.getElementById('resultCostDetails');
      costDetails.innerHTML = '';
      
      // 根据车型类型填充不同的成本明细
      if (carType === 'new') {
        addCostDetail(costDetails, '开票价', document.getElementById('invoicePrice').value);
        addCostDetail(costDetails, '国内运输', document.getElementById('domesticShipping').value);
        
        const internationalShipping = document.getElementById('internationalShipping').value;
        if (internationalShipping) {
          addCostDetail(costDetails, '国际运输', internationalShipping);
        }
        
        addCostDetail(costDetails, '退税', document.getElementById('taxRefund').value, true);
        addCostDetail(costDetails, '购车成本', document.getElementById('purchaseCost').value, false, true);
        
        // 报价汇总
        document.getElementById('resultProfit').textContent = formatCurrencyInteger(Math.round(parseFloat(document.getElementById('profit').value) || 0));
        document.getElementById('resultRmbQuote').textContent = formatCurrencyInteger(Math.round(parseFloat(document.getElementById('rmbQuote').value) || 0));
      } else if (carType === 'used') {
        addCostDetail(costDetails, '开票价', document.getElementById('usedInvoicePrice').value);
        addCostDetail(costDetails, '购置税', document.getElementById('usedPurchaseTax').value);
        addCostDetail(costDetails, '资质费用', document.getElementById('usedQualificationFee').value);
        addCostDetail(costDetails, '代办费', document.getElementById('usedAgencyFee').value);
        addCostDetail(costDetails, '退税', document.getElementById('usedTaxRefund').value, true);
        addCostDetail(costDetails, '退税手续费', document.getElementById('usedTaxRefundFee').value);
        addCostDetail(costDetails, '国内运输', document.getElementById('usedDomesticShipping').value);
        
        const internationalShipping = document.getElementById('usedInternationalShipping').value;
        if (internationalShipping) {
          addCostDetail(costDetails, '国际运输', internationalShipping);
        }
        
        addCostDetail(costDetails, '购车成本', document.getElementById('usedPurchaseCost').value, false, true);
        
        // 报价汇总
        document.getElementById('resultProfit').textContent = formatCurrencyInteger(Math.round(parseFloat(document.getElementById('usedProfit').value) || 0));
        document.getElementById('resultRmbQuote').textContent = formatCurrencyInteger(Math.round(parseFloat(document.getElementById('usedRmbQuote').value) || 0));
      }
      
      // 最终报价
      const currency = document.getElementById('currency').value;
      const currencyText = currency === 'USD' ? '美元 (USD)' : currency === 'EUR' ? '欧元 (EUR)' : currency === 'GBP' ? '英镑 (GBP)' : '';
      document.getElementById('resultCurrencyText').textContent = `最终报价 (${currencyText})`;
      document.getElementById('resultFinalQuote').textContent = formatCurrencyInteger(Math.round(parseFloat(document.getElementById('finalQuote').value) || 0), currency);
    }
    
    // 添加成本明细项
    function addCostDetail(container, label, value, isNegative = false, isTotal = false) {
      const li = document.createElement('li');
      li.className = `flex justify-between ${isTotal ? 'pt-2 border-t border-gray-100 font-medium' : ''}`;
      
      const spanLabel = document.createElement('span');
      spanLabel.className = 'text-gray-600';
      spanLabel.textContent = `${label}:`;
      
      const spanValue = document.createElement('span');
      spanValue.className = isNegative ? 'text-green-600' : isTotal ? 'text-primary' : '';
      
      // 购置税和退税保留小数点后两位，其他取整数
      let displayValue;
      if (label === '购置税' || label === '退税') {
        displayValue = formatCurrency(parseFloat(value) || 0);
      } else {
        displayValue = formatCurrencyInteger(Math.round(parseFloat(value) || 0));
      }
      spanValue.textContent = displayValue;
      
      li.appendChild(spanLabel);
      li.appendChild(spanValue);
      container.appendChild(li);
    }
    
    // 初始化页面时设置默认值
    window.addEventListener('DOMContentLoaded', function() {
      // 设置手续费滑块默认值
      const serviceFeeRate = document.getElementById('serviceFeeRate');
      const serviceFeeRateValue = document.getElementById('serviceFeeRateValue');
      
      serviceFeeRate.value = '0.04';
      serviceFeeRateValue.textContent = '0.04';
      
      // 自动显示新车表单
      document.getElementById('newCarForm').classList.remove('hidden');
      document.getElementById('newCarForm').classList.add('animate-fadeIn');
      
      // 显示汇率区域
      document.getElementById('currencySection').classList.remove('hidden');
      
      // 自动获取美元汇率
      fetchExchangeRate('USD');
    });

    // 获取汇率
    function fetchExchangeRate(currency) {
      const exchangeRateInput = document.getElementById('exchangeRate');
      const exchangeRateLabel = document.getElementById('exchangeRateLabel');
      exchangeRateInput.value = '加载中...';
      
      // Open Exchange Rates API
      const appId = '9625bee048bd4599842279906b9ca677';
      fetch(`https://openexchangerates.org/api/latest.json?app_id=${appId}&symbols=USD,EUR,GBP,CNY`)
        .then(res => res.json())
        .then(data => {
          let rate = 0;
          if (currency === 'USD') {
            rate = data.rates.CNY / data.rates.USD;
          } else if (currency === 'EUR') {
            rate = data.rates.CNY / data.rates.EUR;
          } else if (currency === 'GBP') {
            rate = data.rates.CNY / data.rates.GBP;
          }
          
          // 标题显示原始汇率（小数点后两位）
          exchangeRateLabel.textContent = `汇率 实时基准：${rate.toFixed(2)}`;
          // 数值栏显示减去0.05后的汇率（小数点后两位）
          exchangeRateInput.value = (rate - 0.05).toFixed(2);
          calculateFinalQuote();
        })
        .catch(() => {
          exchangeRateInput.value = '';
          exchangeRateLabel.textContent = '汇率 实时基准：获取失败';
          alert('汇率获取失败，请稍后重试');
        });
    }

    // 车型搜索功能
    let searchTimeout;
    const carModelInput = document.getElementById('carModel');
    const carSearchResults = document.getElementById('carSearchResults');
    
    // 监听车型名称输入
    carModelInput.addEventListener('input', function() {
      const keyword = this.value.trim();
      
      // 清除之前的定时器
      clearTimeout(searchTimeout);
      
      // 隐藏搜索结果
      carSearchResults.classList.add('hidden');
      
      if (keyword.length >= 2) {
        // 延迟搜索，避免频繁请求
        searchTimeout = setTimeout(() => {
          searchCarModel(keyword);
        }, 500);
      }
    });
    
    // 搜索车型
    async function searchCarModel(keyword) {
      try {
        // 显示加载状态
        carSearchResults.innerHTML = '<div class="p-4 text-center text-gray-500">搜索中...</div>';
        carSearchResults.classList.remove('hidden');
        
        // 调用后端API
        const response = await fetch(`http://localhost:3000/api/search-car?keyword=${encodeURIComponent(keyword)}`);
        
        if (!response.ok) {
          throw new Error('搜索失败');
        }
        
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          displayCarResults(result.data);
        } else {
          // 尝试备用API
          await searchCarModelFallback(keyword);
        }
        
      } catch (error) {
        console.error('搜索车型失败:', error);
        // 使用备用方案
        await searchCarModelFallback(keyword);
      }
    }
    
    // 备用搜索方案
    async function searchCarModelFallback(keyword) {
      try {
        const response = await fetch(`http://localhost:3000/api/search-car-fallback?keyword=${encodeURIComponent(keyword)}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          displayCarResults(result.data);
        } else {
          carSearchResults.innerHTML = '<div class="p-4 text-center text-gray-500">未找到相关车型</div>';
        }
      } catch (error) {
        carSearchResults.innerHTML = '<div class="p-4 text-center text-gray-500">搜索服务暂时不可用</div>';
      }
    }
    
    // 显示搜索结果
    function displayCarResults(cars) {
      carSearchResults.innerHTML = '';
      
      cars.forEach(car => {
        const carItem = document.createElement('div');
        carItem.className = 'p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-custom';
        carItem.innerHTML = `
          <div class="flex items-center space-x-3">
            ${car.image ? `<img src="${car.image}" alt="${car.name}" class="w-12 h-8 object-cover rounded">` : '<div class="w-12 h-8 bg-gray-200 rounded flex items-center justify-center"><i class="fa fa-car text-gray-400"></i></div>'}
            <div class="flex-1">
              <div class="font-medium text-gray-900">${car.name}</div>
              <div class="text-sm text-gray-500">${car.price}</div>
            </div>
          </div>
        `;
        
        // 点击选择车型
        carItem.addEventListener('click', () => {
          carModelInput.value = car.name;
          carSearchResults.classList.add('hidden');
          
          // 如果价格包含数字，自动填充指导价
          const priceMatch = car.price.match(/(\d+(?:\.\d+)?)/);
          if (priceMatch) {
            const price = parseFloat(priceMatch[1]);
            if (price > 0) {
              document.getElementById('guidePrice').value = Math.round(price * 10000); // 转换为元
            }
          }
        });
        
        carSearchResults.appendChild(carItem);
      });
      
      carSearchResults.classList.remove('hidden');
    }
    
    // 点击其他地方隐藏搜索结果
    document.addEventListener('click', function(event) {
      if (!carModelInput.contains(event.target) && !carSearchResults.contains(event.target)) {
        carSearchResults.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
